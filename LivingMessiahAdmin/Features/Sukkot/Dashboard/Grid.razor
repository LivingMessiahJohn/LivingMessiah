@using LivingMessiahAdmin.Features.Sukkot.Dashboard.Data
@using Microsoft.AspNetCore.Components.QuickGrid
@using FilterEnums = LivingMessiahAdmin.Features.Sukkot.Dashboard.Enums.Filter
@using ShowColumnEnums = LivingMessiahAdmin.Features.Sukkot.Dashboard.Enums.ShowColumn

@inject ILogger<Grid>? Logger
@inject IRepository? db;
@inject IToastService? Toast
@inject ExportCSV ExportCSV

<LoadingComponent IsLoading="items == null" TurnSpinnerOff=TurnSpinnerOff>
  @if (items != null)
  {
    <TopRowButtons  OnCommandDoExport="ReturnedOnCommandDoExport" />
    

    @if (TotalsCardRecord is not null)
    {
      <FilterRowCount Rows="TotalsCardRecord.RowCnt"
                      FilteredRows="@(FilteredItems?.Count() ?? 0)"
                      SearchFilter="@nameFilter" />
    }

    <div class="@MediaQuery.XsOrSm.DivClass">
      <ShowColumnSelector Bitwise=Bitwise IsXsOrSm="true" OnShowColumnChanged="ReturnedShowColumn" />
    </div>
    <div class="d-none d-md-block">
      <ShowColumnSelector Bitwise=Bitwise IsXsOrSm="false" OnShowColumnChanged="ReturnedShowColumn" />
    </div>

    @if (SelectedItem != null)
    {
      <DetailCard rec="DetailCardRecord" OnClose="ReturnedCloseAction" />
    }

    <QuickGrid Items="FilteredItems" TGridItem="GridQuery" Class="table table-striped table-hover">
      <TemplateColumn Title="Id" Sortable="true" Align=Align.Center SortBy="@(GridSort<GridQuery>.ByAscending(x => x.Id))">
        <b>@context.Id</b>
        <button @onclick="@(() => ShowDetails(context))" class="btn btn-sm btn-outline-primary d-print-none">
          <i class="fas fa-caret-up"></i>
        </button>
      </TemplateColumn>

      <PropertyColumn Property="@(item => item.FullNameOrNA)" Title="Name" Sortable="true" IsDefaultSortColumn="true">
        <ColumnOptions>
          <div class="search-box">
            <input type="search" autofocus @bind="nameFilter" @bind:event="oninput" placeholder="filter by name" />
          </div>
        </ColumnOptions>
      </PropertyColumn>

      @if (ShowColumnRecord!.ShowEmail)
      {
        <PropertyColumn Property="@(item => item.EMail)" Title="EMail" Sortable="true" />
      }

      @if (ShowColumnRecord!.ShowPhone)
      {
        <PropertyColumn Property="@(item => item.Phone)" Title="Phone" />
      }


      @if (ShowColumnRecord!.ShowPeople)
      {
        <PropertyColumn Property="@(item => item.People)" Align=Align.Center Title="People" />
      }

      @if (ShowColumnRecord!.ShowPaid)
      {
        <TemplateColumn Title="Paid" Align=Align.Center>
          <div class="@context.TotalDonationClass text-center">
            @context.TotalDonationNoCents
          </div>
        </TemplateColumn>
      }


      @if (ShowColumnRecord!.ShowAttendance)
      {
        <TemplateColumn Title="@Constants.GridHelper.GetAttendanceDatesColumnHeader()" Align=Align.Center>
          <div class="">
            <div>
              <span style="white-space: pre;">@context.AttendanceColumnValue</span>
            </div>
          </div>
        </TemplateColumn>
      }

      @if (ShowColumnRecord!.ShowNotes)
      {
        <TemplateColumn Title="Notes" Align=Align.Center>
          <span class="@(context.HasAdminNotes ? "bg-warning p-1" : "p-1")">A</span>
          <span class="text-black-50"> | </span>
          <span class="@(context.HasNotes ? "bg-info p-1" : "p-1")">U</span>
        </TemplateColumn>
      }

    </QuickGrid>

    @if (TotalsCardRecord is not null)
    {
      <TotalsCard TotalsCardRecord="TotalsCardRecord" />
    }


  }
</LoadingComponent>

@code {
    [Parameter, EditorRequired] public required FilterEnums? Filter { get; set; } = FilterEnums.RegisteredOrPaid;


    string nameFilter = string.Empty;

  protected TotalsCardRecord? TotalsCardRecord { get; set; }

  bool TurnSpinnerOff = false;


  protected IQueryable<GridQuery>? items;
  IQueryable<GridQuery>? FilteredItems => items?.Where(x => x.FullName!.Contains(nameFilter, StringComparison.CurrentCultureIgnoreCase));

  protected override async Task OnParametersSetAsync()
  {
    Logger!.LogDebug("{Method} {Message}", nameof(OnParametersSetAsync), $"Filter: {Filter!.Name}");

    try
    {
      if (ShowColumnRecord == null) { ShowColumnRecord = PopulateShowColumn(Bitwise); }

      if (Filter == null)
      {
        throw new ArgumentNullException(nameof(Filter), $"{nameof(Filter)} is null");
      }
      else
      {
        items = (await db!.GetAll(Filter)).AsQueryable();
        if (items is not null)
        {
          TotalsCardRecord = new TotalsCardRecord(items.Count(), items.Sum(s => s.Adults), items.Sum(s => s.Children));
        }
        else
        {
          Logger!.LogWarning("{Method} {Message}", nameof(OnParametersSetAsync), "RegistrationList is null");
          Toast!.ShowWarning($"RegistrationList is null");
        }
      }
    }
    catch (Exception ex)
    {
      Logger!.LogError(ex, "{Method}", nameof(OnParametersSetAsync));
      Toast!.ShowError($"An invalid operation occurred, contact your administrator | {nameof(OnParametersSetAsync)}");
    }
    TurnSpinnerOff = true;

  }

  private GridQuery? SelectedItem = null;

  private static readonly GridSort<GridQuery>
    GridSort = GridSort<GridQuery>
      .ByAscending(p => p.FullNameOrNA);

  private DetailCardRecord? DetailCardRecord;
  private void ShowDetails(GridQuery? item)
  {
    if (item is not null)
    {
      SelectedItem = item;
      DetailCardRecord = new DetailCardRecord(item.Id, item!.FullName ?? "None", item!.AdminNotes ?? "", item!.Notes ?? "");
    }
  }

  private void ReturnedCloseAction()
  {
    SelectedItem = null;
  }


  private async Task ReturnedOnCommandDoExport()
  {
    if (FilteredItems != null)
    {
      await ExportCSV.DownloadCSV(FilteredItems.ToList());
    }
  }


  // Initial default setting done by using `Bitwise Operator` `|` (OR).
  protected int Bitwise = ShowColumnEnums.Email.Value | ShowColumnEnums.People.Value | ShowColumnEnums.Attendance.Value;
  protected ShowColumnRecord? ShowColumnRecord; // = PopulateShowColumn(Bitwise);

  // Using the `Bitwise Operator` `&` (AND) to determine if a column should be shown or not.

  private void ReturnedShowColumn(int bitwise)
  {
    Bitwise = bitwise;
    ShowColumnRecord = PopulateShowColumn(bitwise);
    Logger!.LogDebug("{Method} {Message}", nameof(ReturnedShowColumn), $"Returned Bitwise: {bitwise}");
  }

  private ShowColumnRecord PopulateShowColumn(int bitwise)
  {
    return new ShowColumnRecord(
    (bitwise & ShowColumnEnums.Email.Value) == ShowColumnEnums.Email.Value,
    (bitwise & ShowColumnEnums.Phone.Value) == ShowColumnEnums.Phone.Value,
    (bitwise & ShowColumnEnums.People.Value) == ShowColumnEnums.People.Value,
    (bitwise & ShowColumnEnums.Paid.Value) == ShowColumnEnums.Paid.Value,
    (bitwise & ShowColumnEnums.Notes.Value) == ShowColumnEnums.Notes.Value,
    (bitwise & ShowColumnEnums.Attendance.Value) == ShowColumnEnums.Attendance.Value
    );
  }

}
