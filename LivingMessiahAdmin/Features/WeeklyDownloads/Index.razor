@page "/WeeklyDownload"

@using LivingMessiahAdmin.Features.WeeklyDownloads.Data
@using Microsoft.AspNetCore.Components.Forms
@using TriennialEnum = RCL.Features.Parasha.Enums.Triennial

@using LivingMessiahAdmin.SecurityRoot
@using Microsoft.AspNetCore.Components.Authorization
@using DataTypeEnums = RCL.Features.Calendar.Enums.DateType;
@using FeastDatEnum = RCL.Features.Calendar.Enums.FeastDay;

@using RCL.Features.Storage
@using RCL.Components

@using Page = LivingMessiahAdmin.Enums.Nav

@inject ILogger<Index>? Logger
@inject IToastService? Toast
@inject AzureBlobService BlobService


<PageHeader PageEnum="Page.WeeklyDownload" />

@* ToDo: add different RoleGroup.UploadToBlo or something *@
<AuthorizeView Policy=@RoleGroup.KeyDates>
  <Authorized>



		<div class="row">
			<div class="col-sm-6 my-1">
				<InputFile OnChange="OnInputFileChange" class="form-control" />
				@if (selectedFile is not null)
				{
					<div class="small text-muted mt-1">@selectedFile.Name (@FormatBytes(selectedFileSize))</div>
				}

				<div class="col-md-2 text-end">

					@if (IsDisabled == true)
					{
						<button class="btn btn-primary btn-sm m-2" @onclick="UploadToAzure" disabled>
							@if (isUploading)
							{
								<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
								<span>&nbsp;Uploading</span>
							}
							else
							{
								<span class="fas fa-upload">&nbsp;Upload</span>
							}
						</button>
					}
					else
					{
						<button class="btn btn-primary btn-sm m-2" @onclick="UploadToAzure">
							@if (isUploading)
							{
								<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
								<span>&nbsp;Uploading</span>
							}
							else
							{
								<span class="fas fa-upload">&nbsp;Upload</span>
							}
						</button>
					}

				</div>

			</div>
			<div class="col-sm-6 my-1">
				<SelectorDropDown SelectedOption="@fileName"
													SelectedOptionChanged="ReturnedFilename"
													Options="@GetStringArrays()" />

			</div>
		</div>

		<hr />

		<div class="mb-3">
			<label class="form-label mb-1">Upload progress</label>
			<div class="progress" style="height: 1.5rem;">
				<div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
						 role="progressbar"
						 style="width:@($"{uploadProgress}%")"
						 aria-valuenow="@uploadProgress"
						 aria-valuemin="0"
						 aria-valuemax="100">
					@if (uploadProgress == 100)
					{
						<span>Complete</span>
					}
					else
					{
						<span>@uploadProgress% </span>
						<small class="text-muted">(@(selectedFileSize > 0 ? FormatBytes((long)(selectedFileSize * uploadProgress / 100.0)) : "0 B") uploaded)</small>
						<small class="text-muted"> FormatBytes disabled</small>
					}
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-12 my-1">
				@if (!string.IsNullOrWhiteSpace(uploadedBlobUrl))
				{
					<p>
						Uploaded blob URL:
						<a href="@uploadedBlobUrl" target="_blank" rel="noopener">@uploadedBlobUrl</a>
					</p>
				}
			</div>
		</div>

		@* 
<p>
	IsDisabled: @IsDisabled <br />
	isUploading: @isUploading <br />
	filename: @fileName  <br />
	selectedFile: @(selectedFile is null || string.IsNullOrEmpty(selectedFile.Name) ? "NULL" : selectedFile.Name)
</p> 
*@

	</Authorized>
	<NotAuthorized>
		<div class="alert alert-warning text-end" role="alert">
			<small>Not Authorized; Role Group Policy: @RoleGroup.KeyDates</small>
		</div>
		<LoginRedirectCard Nav="Nav.KeyDates" ReturnUrl=@Nav.KeyDates.Index />
	</NotAuthorized>
</AuthorizeView>




@code {

	private bool IsDisabled { get; set; } = true;

	private bool isUploading = false;
	private void ToggleDisabled()
	{
		if (isUploading || string.IsNullOrWhiteSpace(fileName) || selectedFile is null)
		{
			IsDisabled = true;
		}	
		else
		{
			IsDisabled = false;
		}

	}

	protected string fileName = "";
	private IEnumerable<string> GetStringArrays()
	{
		return RCL.Features.Parasha.Enums.Triennial.List
		.OrderBy(o => o.Date)
		.Select(triennial => triennial.WeeklyReadingParashaFile);
	}

	protected FileUploadResultRecord? result;

	private IBrowserFile? selectedFile;
	private long selectedFileSize;
	private int uploadProgress = 0;

	private string uploadedBlobUrl = string.Empty;

	protected override void OnInitialized()
	{
		TriennialEnum? currentReading = RCL.Features.Parasha.Helpers.GetCurrentReading();
		string? s = currentReading!.WeeklyReadingParashaFile;
		fileName = string.IsNullOrWhiteSpace(s) ? "" : s;
	}

	void ReturnedFilename(string returnFile)
	{
		Logger!.LogDebug("{Method} {Msg}", nameof(ReturnedFilename), $"returnFile: {returnFile}");
		fileName = returnFile;
		ToggleDisabled();
	}

	private void OnInputFileChange(InputFileChangeEventArgs e)
	{
		selectedFile = e.File;
		selectedFileSize = selectedFile.Size;
		uploadProgress = 0;
		ToggleDisabled();
		StateHasChanged();  //
	}

	async Task UploadToAzure()
	{
		if (selectedFile is null)
		{
			Toast?.ShowWarning("Please choose a local file before uploading.");
			return;
		}
		if (string.IsNullOrWhiteSpace(fileName))
		{
			Toast?.ShowWarning("Please choose a target from the dropdown.");
			return;
		}

		isUploading = true;
		uploadProgress = 0;
		result = null;
		uploadedBlobUrl = string.Empty;
		StateHasChanged();

		try
		{
			var target = fileName; // e.g. "Exo-04-14-to-06-01"
			Toast?.ShowInfo($"target: {target}");

			// Use a temporary path (safe, no hard-coded repo path). Use WebRootPath if you want
			// files under wwwroot: var basePath = Env.WebRootPath;
			var tempDir = Path.GetTempPath();
			var tempFilePath = Path.Combine(tempDir, selectedFile.Name);

			try
			{
				// Save the uploaded browser file to a temp file
				const long maxAllowedSize = 1024L * 1024L * 80; // 80 MB (adjust as needed)
				await using (var fs = File.Create(tempFilePath))
				await using (var stream = selectedFile.OpenReadStream(maxAllowedSize))
				{
					await stream.CopyToAsync(fs);
				}

				// Start the upload using your existing API that accepts a local path
				var uploadTask = BlobService.UploadAsync(tempFilePath, target);

				// Animate progress while upload is running
				while (!uploadTask.IsCompleted)
				{
					uploadProgress = Math.Min(95, uploadProgress + 5);
					StateHasChanged();
					await Task.Delay(200);
				}

				// Await final result
				result = await uploadTask;
				uploadProgress = result!.Success ? 100 : uploadProgress;
				if (result.Success)
				{
					uploadedBlobUrl = BlobService.GetBlobUrl(target);
					Toast?.ShowSuccess("Upload finished.");
				}
				else
				{
					Toast?.ShowError("Upload failed.");
				}
			}
			finally
			{
				// Clean up the temporary file if it exists
				try { if (File.Exists(tempFilePath)) File.Delete(tempFilePath); } catch { /* swallow cleanup errors */ }
			}
		}
		catch (Exception ex)
		{
			Logger?.LogError(ex, "Upload failed");
			result = new FileUploadResultRecord(false, $"Exception: {ex.Message}");
		}
		finally
		{
			isUploading = false;
			ToggleDisabled();
			StateHasChanged();
		}
	}

	private static string FormatBytes(long bytes)
	{
		if (bytes <= 0) return "0 B";
		string[] sizes = { "B", "KB", "MB", "GB", "TB" };
		var order = (int)Math.Floor(Math.Log(bytes, 1024));
		var adjusted = Math.Round(bytes / Math.Pow(1024, order), 2);
		return $"{adjusted} {sizes[order]}";
	}
	
}
